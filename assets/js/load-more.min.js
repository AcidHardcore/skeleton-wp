jQuery(document).ready((function(e){"use strict";new Filter}));class Filter{constructor(){this.$parentBox=$(".js-article-wrap"),this.$head=$(".articles--list"),this.$sep=this.$head.find(".js-sep"),this.$pagination=$(".pagination"),this.$pageLinks=this.$pagination.find(".page-numbers"),this.$reset=$(".as-b--link.js-reset"),this.$searchWrapper=$(".form-item-search"),this.$searchInput=this.$searchWrapper.find("input"),this.$searchReset=this.$searchWrapper.find(".search-reset.js-reset"),this.$spinner=this.$searchWrapper.find(".search-spinner"),this.url=new URL(window.location),this.params=this.url.searchParams,this.newUrl="",this.timeout=null,this.searchArgs={},this.$filters=$(".js-filter"),this.$featured=$(".js-featured-articles"),this.visualFilters=$(".gform_wrapper__resources.gform_wrapper.gravity-theme .form-custom .chosen-container .chosen-single"),this.activeFilters={},this.filtersHandler(),this.searchHandler(),this.paginationHandler(),this.resetHandler(),this.historyHandler()}filtersHandler(){this.$filters.on("change",(e=>{const s=$(e.currentTarget),t=s.data("filter"),a=s.val();this.buildQueryArgs(t,a),this.params.delete("pages"),this.setURLParam(t),this.getNews(args,this.$parentBox,this.$pagination),this.updateFilterBackground(s)})),this.$filters.each(((e,s)=>{const t=$(s);this.updateFilterBackground(t)}))}buildQueryArgs(e,s){args.paged=1,s?this.activeFilters[e]=[s]:delete this.activeFilters[e];const t=Object.entries(this.activeFilters).map((([e,s])=>({taxonomy:e,field:"slug",terms:s})));t.length>0&&(args.tax_query={relation:"AND",...t})}searchHandler(){this.$searchInput.on("keyup",(e=>{e.preventDefault(),null!==this.timeout&&clearTimeout(this.timeout),this.searchArgs=structuredClone(args),this.searchArgs.search=this.$searchInput.val(),this.searchArgs.paged=1;this.searchArgs.search.length>2&&(13!==e.keyCode?this.timeout=setTimeout((()=>{this.getTitles(this.searchArgs,this.$searchWrapper,this.$searchInput)}),1e3):(args=structuredClone(this.searchArgs),this.resetSearchResultHint(),this.params.delete("pages"),this.setURLParam("search"),this.getNews(args,this.$parentBox,this.$pagination,this.$head)))})),document.addEventListener("click",(e=>{const s=document.querySelector(".search-results");s&&(s.contains(e.target)||(this.$searchInput.val(""),this.$searchReset.addClass("hidden"),this.resetSearchResultHint()))})),this.updateSearchBackground(this.$searchInput)}paginationHandler(){this.$pageLinks.on("click",(e=>{this.scrollToTarget(this.$head),this.ajaxPagination(e)}))}resetHandler(){this.$searchReset.on("click",(e=>{e.preventDefault(),this.restAll(),this.getNews(args,this.$parentBox,this.$pagination,this.$searchWrapper)})),this.$reset.on("click",(e=>{e.preventDefault(),this.restAll(),this.$filters.each(((e,s)=>{const t=$(s);t.val("");t.find("option").each(((e,s)=>{$(s).prop("disabled",!1)})),t.next().removeClass("selected")})),this.$filters.trigger("chosen:updated"),this.$featured.removeClass("hidden"),this.$parentBox.html(""),this.$pagination.html(""),this.$head.removeClass("block-full--pad"),this.$sep.addClass("hidden"),this.scrollToTarget(this.$searchWrapper),this.updateBackgroundColor(this.visualFilters,"#d8d8d8")}))}historyHandler(){window.addEventListener("popstate",(e=>{location.reload()}))}async getNews(e,s,t,a=!1){s.classList.add("is-loading"),t.style.display="block";try{const r=await fetch(load_more_vars.api_url,{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":load_more_vars.nonce},body:JSON.stringify({query_args:e,current_url:window.location.href})});if(!r.ok)throw new Error(`HTTP error! Status: ${r.status}`);const i=await r.json();i&&i.posts_html?(s.innerHTML=i.posts_html,t.innerHTML=i.pagination,this.hideShowFilters(i)):(s.innerHTML='<div class=""><h3>No matching results.</h3></div>',t.style.display="none")}catch(e){console.error("Failed to fetch posts:",e),s.innerHTML=`<div class=""><h3>Error: ${e.message}</h3></div>`,t.style.display="none"}finally{s.classList.remove("is-loading"),this.paginationEl=document.querySelector(".pagination"),this.paginationEl&&(this.pageLinks=this.paginationEl.querySelectorAll(".page-numbers"),this.paginationHandler()),this.headEl&&this.headEl.classList.add("block-full--pad"),this.sepEl&&this.sepEl.classList.remove("hidden"),this.featuredEl&&this.featuredEl.classList.add("hidden"),a&&this.scrollToTarget(a)}}getTitles(e,s,t){$.ajax({url:`${this.url.protocol}//${this.url.hostname}/wp-json/load-more/v1/titles/?data=${JSON.stringify(e)}`,method:"GET",dataType:"JSON",beforeSend:()=>{this.$searchWrapper.find(".search-results").remove(),this.$spinner.removeClass("hidden"),this.$searchReset.removeClass("hidden")},success:e=>{e&&e.titles?s.append(e.titles):s.append(`<div class="search-results">No results found for ${t.val()}</div>`)},error:e=>{console.error(e)},complete:()=>{this.$spinner.addClass("hidden")}})}ajaxPagination(e){e.preventDefault();const s=$(e.currentTarget);s.attr("href");let t=s.text();"next"===t&&(t=parseInt(args.paged)+1),"prev"===t&&(t=parseInt(args.paged)-1),args.paged=t,this.setURLParam("pages",t),this.getNews(args,this.$parentBox,this.$pagination)}scrollToTarget(e){$("html, body").animate({scrollTop:e.offset().top-100},400)}setURLParam(e,s=""){s?this.params.set(e,s):null===args[e]||""===args[e]?this.params.delete(e):this.params.set(e,args[e]),this.newUrl=`${window.location.protocol}//${window.location.host}${window.location.pathname}?${this.params.toString()}`,window.history.pushState({path:this.newUrl},"",this.newUrl),this.createCookie("filters",this.params.toString(),365),this.createCookie("resources_url",`${window.location.protocol}//${window.location.host}${window.location.pathname}`,365)}clearAllURLParams(){let e=[];this.params.forEach(((s,t)=>{e.push(t)})),e.forEach((e=>{this.params.delete(e)})),this.newUrl=`${window.location.protocol}//${window.location.host}${window.location.pathname}?${this.params.toString()}`,window.history.pushState({path:this.newUrl},"",this.newUrl),this.createCookie("filters","",365),this.createCookie("resources_url","",365)}restAll(){this.$searchInput.val(""),args.paged=1,args.type="",args.industry="",args.category="",args.search="",this.$searchReset.addClass("hidden"),this.clearAllURLParams()}hideShowFilters(e){this.$filters.each(((s,t)=>{const a=$(t),r=a.data("filter");a.find("option").each(((s,t)=>{const a=$(t);"resource_type"!==r||Object.values(e.resource_type).includes(a.val())||a.prop("disabled",!0),"industry"!==r||Object.values(e.industry).includes(a.val())||a.prop("disabled",!0),"category"!==r||Object.values(e.category).includes(a.val())||a.prop("disabled",!0),"resource_type"===r&&Object.values(e.resource_type).includes(a.val())&&a.prop("disabled",!1),"industry"===r&&Object.values(e.industry).includes(a.val())&&a.prop("disabled",!1),"category"===r&&Object.values(e.category).includes(a.val())&&a.prop("disabled",!1)})),a.trigger("chosen:updated")}))}resetSearchResultHint(){this.searchArgs={},this.$searchWrapper.find(".search-results").remove()}updateBackgroundColor(e,s){e.css("background-color",s)}updateFilterBackground(e){""!==e.val()&&this.updateBackgroundColor(e.closest(".form-item").find(".chosen-single"),"#ffffff"),null!==e.val()&&""!==e.val()||this.updateBackgroundColor(e.closest(".form-item").find(".chosen-single"),"#d8d8d8")}updateSearchBackground(e){""!==e.val()&&this.updateBackgroundColor(e,"#ffffff")}createCookie(e,s,t){let a;if(t){let e=new Date;e.setTime(e.getTime()+24*t*60*60*1e3),a="; expires="+e.toGMTString()}else a="";const r=new URL(window.location).hostname;document.cookie=e+"="+s+a+"; path=/; domain=."+r}}